{% extends "base.html" %}

{% block stylesheets %}
  {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-datetimepicker.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-select.min.css') }}" />
{% endblock %}

{% block content %}

  {% if is_archived %}
  <div class="alert alert-info alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <strong>Note:</strong> This is an archived version of the object information. For the current information, <a href="{{ url_for('frontend.object', object_id=object_id) }}">click here</a>.
  </div>
  {% endif %}

  <h3>{{ object_type }} #{{ object_id }}: {{ data['name']['text'] }}</h3>

  <h4>Information</h4>
  <div class="row" style="padding-right:0.75em">
    <label class="col-md-3" style="text-align: right">Instrument</label>
    <div class="col-md-9">{% if instrument is not none %}<a href="{{ url_for('frontend.instrument', instrument_id=instrument.id) }}">{{ instrument.name }}</a>{% else %}&mdash;{% endif %}</div>
  </div>
  <div class="row" style="padding-right:0.75em">
    <label class="col-md-3" style="text-align: right">Action</label>
    <div class="col-md-9"><a href="{{ url_for('frontend.action', action_id=action.id) }}">{{ action.name }}</a></div>
  </div>
  {% include "objects/view/any.html" %}
  {% if not is_archived %}
    {% if user_may_edit %}
    <div class="form-group row clearfix" style="padding-right:0.75em">
      <div class="col-md-9 col-md-offset-3">
        <a href="{{ url_for('.object', object_id=object_id, mode='edit') }}" class="btn btn-primary pull-right" style="width:10em">Edit Object</a>
      </div>
    </div>
    {% endif %}
    {% if user_may_grant %}
    <div class="form-group row clearfix" style="padding-right:0.75em">
      <div class="col-md-9 col-md-offset-3">
        <a href="{{ url_for('.object_permissions', object_id=object_id) }}" class="btn btn-primary pull-right" style="width:10em">Edit Permissions</a>
      </div>
    </div>
    {% endif %}
  {% endif %}
    {% if restore_form is not none %}
    <div class="form-group row clearfix" style="padding-right:0.75em">
      <div class="col-md-9 col-md-offset-3">
        <form class="text-center" action="{{ url_for('.restore_object_version', object_id=object_id, version_id=version_id) }}" method="post">
          {{ restore_form.csrf_token() }}
          <button type="submit" class="btn btn-primary pull-right" style="width:10em">Restore Version</button>
        </form>
      </div>
    </div>
    {% endif %}

  {% if object_log_entries %}
    <h4>Activity Log</h4>
    <table class="table" id="activity_log">
      <thead>
        <tr>
          <th scope="col" style="white-space: nowrap;width: 1%;">Datetime</th>
          <th scope="col"></th>
          <th scope="col" class="text-right" style="white-space: nowrap;width: 1%;">
            <button type="button" class="btn btn-sm btn-primary" data-container="body" data-toggle="popover" data-placement="left" data-html="true" data-content="
              <label style='font-weight:400'><input type='checkbox' id='activity_log_filter_versions' onclick='activity_log_toggle($(this).is(&quot;:checked&quot;), &quot;versions&quot;);'/> Versions</label><br />
              <label style='font-weight:400'><input type='checkbox' id='activity_log_filter_measurements' onclick='activity_log_toggle($(this).is(&quot;:checked&quot;), &quot;measurements&quot;);' /> Measurements</label><br />
              <label style='font-weight:400'><input type='checkbox'  id='activity_log_filter_comments' onclick='activity_log_toggle($(this).is(&quot;:checked&quot;), &quot;comments&quot;);' /> Comments</label><br />
              <label style='font-weight:400'><input type='checkbox' id='activity_log_filter_other' onclick='activity_log_toggle($(this).is(&quot;:checked&quot;), &quot;other&quot;);'; /> Other</label>
              <script>
                window.update_activity_log_filter_states();
              </script>
            ">
              <i class="fa fa-filter" style="font-size: 1.5rem"></i> <span class="badge" id="activity_log_counter"></span>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
      {% for object_log_entry in object_log_entries %}
        <tr data-activity-log-type="{{ object_log_entry.type.name.lower() }}">
          <td style="white-space: nowrap;width: 1%;">{{ object_log_entry.utc_datetime.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          {% if object_log_entry.type == ObjectLogEntryType.CREATE_OBJECT %}
            <td>
              <a href="{{ url_for('.user_profile', user_id=object_log_entry.user.id) }}">{{ object_log_entry.user.name }}</a> created the object.
            </td>
            <td class="text-right">
              <a href="{{ url_for('.object_version', object_id=object_id, version_id=0) }}">View</a>
            </td>
          {% elif object_log_entry.type == ObjectLogEntryType.EDIT_OBJECT %}
            <td><a href="{{ url_for('.user_profile', user_id=object_log_entry.user.id) }}">{{ object_log_entry.user.name }}</a> edited the object.</td>
            <td class="text-right">
              {% if 'version_id' in object_log_entry.data %}
                <a href="{{ url_for('.object_version', object_id=object_id, version_id=object_log_entry.data['version_id']) }}">View</a>
              {% endif %}
            </td>
          {% elif object_log_entry.type == ObjectLogEntryType.RESTORE_OBJECT_VERSION %}
            <td><a href="{{ url_for('.user_profile', user_id=object_log_entry.user.id) }}">{{ object_log_entry.user.name }}</a> restored object <a href="{{ url_for('.object_version', object_id=object_id, version_id=object_log_entry.data['restored_version_id']) }}">version #{{ object_log_entry.data['restored_version_id'] }}</a>.</td>
            <td class="text-right">
              {% if 'version_id' in object_log_entry.data %}
                <a href="{{ url_for('.object_version', object_id=object_id, version_id=object_log_entry.data['version_id']) }}">View</a>
              {% endif %}
            </td>
          {% elif object_log_entry.type == ObjectLogEntryType.USE_OBJECT_IN_MEASUREMENT %}
            <td><a href="{{ url_for('.user_profile', user_id=object_log_entry.user.id) }}">{{ object_log_entry.user.name }}</a> used the object in measurement <a href="{{ url_for('.object', object_id=object_log_entry.data['measurement_id']) }}">{{ object_log_entry.data['measurement'].data['name']['text'] }}</a>.</td>
            <td class="text-right">
              {% if 'measurement_id' in object_log_entry.data %}
                <a href="{{ url_for('.object', object_id=object_log_entry.data['measurement_id']) }}">View</a>
              {% endif %}
            </td>
          {% elif object_log_entry.type == ObjectLogEntryType.POST_COMMENT %}
            <td><a href="{{ url_for('.user_profile', user_id=object_log_entry.user.id) }}">{{ object_log_entry.user.name }}</a> posted a comment for this object.</td>
            <td class="text-right">
              {% if 'comment_id' in object_log_entry.data %}
                <a href="#comment-{{ object_log_entry.data['comment_id'] }}">View</a>
              {% endif %}
            </td>
          {% else %}
            <td>Unknown event</td><td></td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
  {% if not is_archived %}
    <h4>Comments</h4>
    {% if comments %}
      {% for comment in comments %}
        <div class="well" id="comment-{{ comment.id }}">
          {{ comment.content }}
          <div class="text-right">&mdash; <a href="{{ url_for('frontend.user_profile', user_id=comment.author.id) }}">{{ comment.author.name }}</a>, {{ comment.utc_datetime.strftime('%Y-%m-%d %H:%M:%S') }}</div>
        </div>
      {% endfor %}
    {% else %}
      <p>There are no comments for this object.</p>
    {% endif %}
    {% if user_may_comment %}
      <form class="form" method="post" action="{{ url_for('frontend.post_object_comments', object_id=object_id) }}" id="new-comment-form">
        {{ comment_form.csrf_token }}
        <div class="form-group">
          <textarea class="form-control" rows="3" placeholder="Comment" style="resize:vertical; min-height:2.5em; margin-bottom: 10px;" name="{{ comment_form.content.name }}">{% if comment_form.content.data %}{{ comment_form.content.data }}{% endif %}</textarea>
        </div>
        <div class="text-right">
          <button type="submit" class="btn btn-primary" style="width:10em; margin-bottom: 20px;">Submit</button>
        </div>
      </form>
    {% endif %}
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/moment-with-locales.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap-datetimepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap-select.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/js.cookie.js') }}"></script>
<script type="text/javascript">
    $(function () {
        $('.input-group.date').each(function() {
          $(this).datetimepicker({
            format: 'YYYY-MM-DD HH:mm:ss',
            date: $(this).attr('data-datetime')
          });
        });
        $('.nav-tabs a').click(function (e) {
          e.preventDefault();
          $(this).tab('show');
        });
      {% if (not is_archived) and user_may_comment %}
        var comment_form = $('#new-comment-form');
        var comment_textarea = comment_form.find('textarea');
        comment_textarea.on('input change propertychange', function() {
            comment_textarea.closest('.form-group').removeClass('has-error');
        });
        comment_form.on('submit', function() {
          if (comment_textarea.val() === "") {
            comment_textarea.closest('.form-group').addClass('has-error');
            comment_textarea.focus();
            return false;
          }
          return true;
        });
      {% endif %}
      {% if object_log_entries %}
        $(function () {
          $('[data-toggle="popover"]').popover()
        });
        var activity_log_filter_type_list = {
          "versions": ['{{ ObjectLogEntryType.CREATE_OBJECT.name.lower() }}', '{{ ObjectLogEntryType.EDIT_OBJECT.name.lower() }}', '{{ ObjectLogEntryType.RESTORE_OBJECT_VERSION.name.lower() }}'],
          "measurements": ['{{ ObjectLogEntryType.USE_OBJECT_IN_MEASUREMENT.name.lower() }}'],
          "comments": ['{{ ObjectLogEntryType.POST_COMMENT.name.lower() }}'],
          "other": ['{{ ObjectLogEntryType.OTHER.name.lower() }}']
        };
        window.activity_log_toggle = function(should_show, category) {
          var type_list = activity_log_filter_type_list[category];
          var activity_log = $('#activity_log').find('> tbody');
          type_list.forEach(function(activity_log_type) {
            var activity_log_rows = activity_log.find('tr[data-activity-log-type='+activity_log_type+']');
            if (should_show) {
              activity_log_rows.css({display: 'table-row'});
            } else {
              activity_log_rows.css({display: 'none'});
            }
          });
          $('#activity_log_counter').html(''+activity_log.find('tr:visible').length+'&thinsp;/&thinsp;'+activity_log.find('tr').length);
          window.activity_log_toggle.current_state[category] = should_show;
          Cookies.set('SAMPLEDB_ACTIVITY_LOG_FILTER_STATE', window.activity_log_toggle.current_state);
        };
        window.activity_log_toggle.current_state = {};
        var activity_log_filter_state = Cookies.getJSON('SAMPLEDB_ACTIVITY_LOG_FILTER_STATE');
        if (activity_log_filter_state === undefined) {
          activity_log_filter_state = {
            "versions": true,
            "measurements": true,
            "comments": true,
            "other": true
          };
          Cookies.set('SAMPLEDB_ACTIVITY_LOG_FILTER_STATE', activity_log_filter_state);
        }
        window.activity_log_toggle(activity_log_filter_state['versions'], "versions");
        window.activity_log_toggle(activity_log_filter_state['measurements'], "measurements");
        window.activity_log_toggle(activity_log_filter_state['comments'], "comments");
        window.activity_log_toggle(activity_log_filter_state['other'], "other");
        window.update_activity_log_filter_states = function() {
          if (window.activity_log_toggle.current_state['versions']) {
            $('#activity_log_filter_versions').attr('checked', 'checked');
          }
          if (window.activity_log_toggle.current_state['measurements']) {
            $('#activity_log_filter_measurements').attr('checked', 'checked');
          }
          if (window.activity_log_toggle.current_state['comments']) {
            $('#activity_log_filter_comments').attr('checked', 'checked');
          }
          if (window.activity_log_toggle.current_state['other']) {
            $('#activity_log_filter_other').attr('checked', 'checked');
          }
        };
      {% endif %}
    });
</script>
{% endblock %}